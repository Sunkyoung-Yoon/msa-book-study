# 5.1 구성(그리고 복잡성) 관리

담당자: 박희선
</br>
</br>
</br>

클라우드에서 실행하는 마이크로서비스에서는 마이크로서비스의 인스턴스가 사람의 개입을 최소화하여 신속하게 시작되어야 하므로 애플리케이션 구성을 관리하는 것이 중요하다. </br></br>
사람이 서비스를 배포하기 위해 수동으로 구성하거나 건드리면 애플리케이션에서 **_구성 불일치나 예기치 않은 장애, 확장 문제 대응_** 을 위한 지연 시간등이 발생할 수 있다. </br>

## 애플리케이션 구성 시 지켜야 할 네 가지 원칙

- 분리
  - 서비스의 물리적 배포에서 서비스 구성 정보를 완전히 분리해야 함
  - 실제로 애플리케이션 구성 정보는 서비스 인스턴스와 함께 배포되어서는 안 되며, 시작 중인 서비스에 환경 변수로 전달되거나 서비스가 시작할 때 중앙 저장소에서 읽어 들여야 함
- 추상화
  - 서비스 인터페이스 뒷단에 있는 구성 데이터의 접근 방식 추상화
  - 애플리케이션 구성 데이터를 조회하는 데 서비스 저장소에서 직접 읽어 오는 코드를 작성하기 보다는 REST 기반 JSON 서비스 사용
- 중앙 집중화
  - 클라우드 기반의 애플리케이션에는 실제로 수백 개의 서비스가 실행될 수 있어 구성 데이터를 보관하는데 사용되는 여러 저장소 수를 최소화하는 것이 중요
  - 가능한 적은 수의 저장소로 애플리케이션 구성 정보 모아야 함
- 견고화
  - 애플리케이션 구성 정보는 배포되는 서비스와 완전히 분리 되고 중앙 집중화 되므로 사용하고 구현할 솔루션은 가용성이 높고 이중화가 필요함

> 구성 정보를 실제 코드 외부로 분리할 때 외부 의존성이 생겨서 이를 관리하고 버전 제어해야 함

⭐️ 애플리케이션 구성을 제대로 관리하지 못하면 탐지하기 어려운 버그와 예기치 않은 장애의 온상이 되기 때문에 애플리케이션 구성 데이터는 **_추적 가능하고 버전을 제어_** 할 수 있어야 함 </br>

## 5.1.1 구성 관리 아키텍처

</br>
마이크로서비스 구성 관리는 부트스트래핑 단계에서 일어남 </br>
p 166 그림 5-1 참고 </br></br>

### 구성 관리의 개념

1. 마이크로서비스 인스턴스가 시작하면 서비스 엔드포인트를 호출하여 동작 중인 환경별 구성 정보를 읽어 오며 구성 관리 서비스에 대한 접속 정보는 마이크로서비스가 시작할 때 전달 됨
2. 실제 구성 정보는 저장소에 보관됨

- 구성 저장소 구현체에 따라 구성 데이터를 보관하는 다양한 방법이 존재함
  - 소스 제어되는 파일, 관계형 데이터베이스, 키-값 데이터 저장소 등

3. 애플리케이션 구성 데이터의 실제 관리는 응용 프로그램이 배포되는 방식과는 독립적으로 함 </br>
   구성 관리에 대한 변경 사항은 일반적으로 빌드 및 배포 파이프라인으로 처리되며, 여기에서 수정 사항에 대한 버전 정보는 태그를 달아 여러 환경(개발, 스테이징, 운영 환경)에 배포
4. 관리하는 구성 정보가 변경되면 애플리케이션 구성 데이터를 사용하는 서비스는 변경 사항을 통지받고 애플리케이션 데이터 복제본 갱신

## 5.1.2 구현 솔루션 선택

시장에서 검증된 많은 오픈 소스 프로젝트를 선택해서 구성 관리 솔루션을 구현할 수 있다
| 프로젝트 이름 | 설명 | 특징 |
| :----- | :----- | :------ |
| etcd | Go 언어로 작성된 오픈 소스 프로젝트로 서비스 디스커버리와 키-값 관리에 사용됨 </br> 분산 컴퓨팅 모델을 위해 raft 프로토콜 사용 | 매우 빠르며 확장 가능 </br> 분산 가능 </br> 명령줄 기반 </br> 사용 및 설치 용이 |
| 유레카 | 넷플릭스가 만들었으며 엄격한 실전 테스트 걸침 </br> 서비스 디스커버리와 키-값 관리에 사용됨 | 분산형 키-값 저장소 </br> 유연하지만 구축하는데 공수 소요 </br> 기본적으로 클라이언트의 동적 갱신 기능 제공 |
| 콘술 | 하시코프가 만들었음 </br> etcd나 유레카와 유사하지만 분산 컴퓨팅 모델에 다른 알고리즘 사용 | 빠름 </br> 직접 DNS와 통합해서 네이티브 서비스 디스커버리 기능 제공 </br> 클라이언트 동적 갱신은 기본 기능에 포함되지 않음 |
| 주키퍼 | 아파치 프로젝트 분산 잠금 기능을 제공 </br> 주로 키-값 데이터를 액세스하는 구성 관리 솔루션으로 사용됨 | 가장 오래되어 실전에서 검증된 솔루션임 </br> 사용하기 가장 복잡함 </br> 구성 관리에 사용 가능하지만 이미 아키텍처에서 사용 중일때만 고려해야 함 |
| 스프링 클라우드 구성 서버 | 오픈 소스 프로젝트로 다양한 백엔드와 함께 전반적인 구성 관리 솔루션 제공 | 비분산형 키-값 저장소 </br> 스프링 및 스프링이 아닌 서비스와 긴밀한 통합 </br> 구성 데이터 저장을 위해 공유 파일 시스템, 유레카, 콘술, 깃 등 다양한 백엔드 사용 가능 |

이 책에서는 스프링 마이크로서비스 아키텍처에 완벽하게 통합된 스프링 클라우드 구성 서버를 사용할 것 </br>
✳️ 스프링 클라우드 컨피그 서버 또는 컨피그 서버라고도 부름

### 채택 이유

- 스프링 클라우드 구성 서버는 설치하기 쉽고, 사용하기도 쉬움
- 스프링 클라우드 구성 서버는 스프링 부트와 밀접하게 통합되어 있음
  - 몇 가지 간단한 애너테이션을 사용하여 애플리케이션의 모든 구성 데이터 읽어 오기 가능
- 스프링 클라우드 구성 서버는 구성 데이터를 저장하는 많은 백엔드 지원
- 스프링 클라우드 구성 서버는 깃 소스 제어 플랫폼이나 하시코프 볼트와 바로 통합 가능

### 5장에서 진행할 일

1. 스프링 클라우드 컨피그 서버 설정

- 애플리케이션 구성 데이터를 제공하는 세 가지 다른 메커니즘 (파일 시스템, 깃 리포지터리, 하시코프 볼트) 시연

2. 라이선싱 서비스가 데이터베이스에서 데이터를 조회하도록 계속 구현
3. 스프링 클라우드 컨피그 서비스가 애플리케이션 구성 데이터를 제공하도록 라이선싱 서비스와 연결
